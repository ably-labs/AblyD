<!DOCTYPE html>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<h1>AblyD Example</h1>

<div class="row">
  <p>This demo will make a request through Ably to our server, telling it to publish output from its current script to the namespace matching a random value. This page is then subscribed to outputs from the server to Ably to the 'RANDOM_ID:serveroutput' channel.</p>
  <p>Make sure to replace the 'YOUR_API_KEY' in the JavaScript with your Ably API key!</p>
  <button onclick="publish()">Publish the command to the server to run the script</button>
</div>

<pre id="log"></pre>
<script>
  // This should eventually be the message ID, but currently the go lib doesn't
  // Let you access the message ID
  const messageID = Math.random();
  // helper function: log message to screen
  function log(type, msg) {
    document.getElementById('log').textContent +=  type + ': '+ JSON.stringify(msg) + '\n';
  }
  // Messages from the server will come as ArrayBuffers, so need decoding
  let enc = new TextDecoder("utf-8");

  // Get an Ably API key from https://www.ably.com/accounts/any/apps/any/api_keys
  let ably = new Ably.Realtime('YOUR_API_KEY');
  let commandChannel = ably.channels.get("command");

  commandChannel.presence.subscribe((msg) => {
    log('Presence', msg.data);
  })

  commandChannel.subscribe("new-instance", (msg) => {
    if (msg.data.MessageID == messageID) {
      let inputChannel = ably.channels.get(msg.data.Pid + ":serverinput");
      let outputChannel = ably.channels.get("[?rewind=20]" + msg.data.Pid + ":serveroutput");
      outputChannel.subscribe((msg) => {
        log('Message', enc.decode(msg.data));
      });
    }
  });

  function publish() {
    let data = {
      "MessageID": messageID.toString()
    };
    commandChannel.publish("start", data);
  }
</script>
